<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Legal Document Analyzer</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      padding: 20px;
    }

    .container {
      max-width: 1200px;
      margin: 0 auto;
      background: rgba(255,255,255,0.95);
      backdrop-filter: blur(10px);
      padding: 30px;
      border-radius: 20px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
    }

    h1 {
      color: #2c3e50;
      margin-bottom: 30px;
      text-align: center;
      font-size: 2.5em;
      font-weight: 300;
      text-shadow: 2px 2px 4px rgba(0,0,0,0.1);
    }

    /* upload, api, progress, main layout (unchanged) */
    .upload-section { border: 3px dashed #bdc3c7; padding: 50px; text-align: center; margin-bottom: 30px; border-radius: 15px; cursor: pointer; background: linear-gradient(45deg,#f8f9fa,#e9ecef); transition: all .3s ease; position: relative; overflow: hidden; }
    .upload-section:hover { border-color: #3498db; transform: translateY(-5px); box-shadow: 0 15px 30px rgba(52,152,219,0.3); }
    #fileInput { display:none; }

    .api-section { margin-bottom: 30px; padding: 25px; background: rgba(236,240,241,0.8); border-radius: 15px; backdrop-filter: blur(5px); }
    .api-section label { display:block; margin-bottom:8px; font-weight:600; color:#2c3e50; }
    .api-section select, .api-section input { width:100%; padding:12px; border:2px solid #bdc3c7; border-radius:8px; font-size:14px; margin-bottom:15px; transition: border-color .3s ease; }
    .api-section select:focus, .api-section input:focus { outline:none; border-color:#3498db; box-shadow:0 0 10px rgba(52,152,219,0.3); }

    .progress { display:none; margin:30px 0; }
    .progress-bar { width:100%; height:25px; background:#ecf0f1; border-radius:15px; overflow:hidden; box-shadow: inset 0 2px 5px rgba(0,0,0,0.1); }
    .progress-fill { height:100%; background: linear-gradient(90deg,#3498db,#2ecc71); width:0%; transition: width .3s ease; border-radius:15px; }

    .main-content { display:grid; grid-template-columns:1fr 1fr; gap:30px; margin-top:30px; }
    .text-panel, .analysis-panel { background: rgba(255,255,255,0.9); border-radius:15px; padding:25px; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }

    .text-display { height:500px; overflow-y:auto; border:2px solid #ecf0f1; border-radius:10px; padding:20px; font-family:'Courier New', monospace; font-size:13px; line-height:1.6; background:#fafafa; }

    .buttons { display:flex; gap:15px; flex-wrap:wrap; margin:20px 0; }
    button { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; border:none; padding:12px 24px; border-radius:25px; cursor:pointer; font-size:14px; font-weight:600; transition: all .3s ease; box-shadow: 0 4px 15px rgba(102,126,234,0.3); }
    button:hover { transform: translateY(-2px); box-shadow:0 8px 25px rgba(102,126,234,0.4); }
    button:active { transform: translateY(0); }
    button:disabled { background:#bdc3c7; cursor:not-allowed; box-shadow:none; }

    .analysis-tabs { display:flex; gap:10px; margin-bottom:20px; }
    .tab { padding:10px 20px; background:#ecf0f1; border:none; border-radius:20px; cursor:pointer; }
    .tab.active { background: linear-gradient(135deg,#667eea 0%,#764ba2 100%); color:white; }

    .tab-content { display:none; }
    .tab-content.active { display:block; }

    .clause-explanation { background: rgba(255,255,255,0.95); border:2px solid #3498db; border-radius:10px; padding:20px; margin:15px 0; box-shadow:0 5px 15px rgba(52,152,219,0.2); }
    .clause-type { display:inline-block; background:#3498db; color:white; padding:4px 8px; border-radius:5px; font-size:12px; font-weight:bold; margin-bottom:10px; }

    .clause-highlight { background: linear-gradient(120deg,#ff6b6b,#feca57); padding:2px 4px; border-radius:4px; cursor:pointer; display:inline-block; box-shadow:0 2px 5px rgba(255,107,107,0.3); }

    .summary-section { display:none; }
    .summary-content { background: rgba(255,255,255,0.9); padding:20px; border-radius:10px; line-height:1.8; min-height:100px; }

    .validity-check { background: rgba(255,255,255,0.95); border-radius:10px; padding:20px; margin:15px 0; box-shadow:0 5px 15px rgba(0,0,0,0.1); border-left:4px solid #3498db; }
    .error { color:#e74c3c; background: linear-gradient(135deg,#ffcccb,#ffebee); padding:15px; border-radius:10px; margin:15px 0; border-left:4px solid #e74c3c; }

    @media (max-width:768px) { .main-content { grid-template-columns: 1fr; } }
  </style>
</head>
<body>
  <div class="container">
    <h1>‚öñÔ∏è AI Legal Document Analyzer</h1>

    <div class="upload-section" id="uploadArea">
      <p style="font-size:1.3em;margin-bottom:10px;">üìÑ Drop your legal document here</p>
      <small>Contracts, agreements, legal documents (PDF format)</small>
    </div>
    <input type="file" id="fileInput" accept=".pdf">

    <div class="api-section">
      <label for="apiProvider">AI Provider:</label>
      <select id="apiProvider">
        <option value="google">Google (Gemini) - Recommended</option>
        <option value="openai">OpenAI (GPT-4, GPT-3.5)</option>
        <option value="anthropic">Anthropic (Claude)</option>
      </select>

      <label for="apiKey">API Key:</label>
      <input type="password" id="apiKey" placeholder="Enter your API key">

      <div class="api-details" id="apiDetails">Your API key is secure and only used for this session</div>
    </div>

    <div class="progress" id="progressContainer">
      <div class="progress-bar"><div class="progress-fill" id="progressFill"></div></div>
      <p id="progressText" style="text-align:center;margin-top:10px;">Processing...</p>
    </div>

    <div class="main-content" id="mainContent" style="display:none;">
      <div class="text-panel">
        <h3>üìã Document Content</h3>
        <div class="buttons">
          <button onclick="analyzeDocument()" id="analyzeBtn">üîç Analyze Clauses</button>
          <button onclick="generateSummary()" id="summaryBtn">üìù Generate Summary</button>
        </div>
        <div class="text-display" id="textDisplay"></div>
      </div>

      <div class="analysis-panel">
        <div class="analysis-tabs">
          <button class="tab active" onclick="showTab('clauses')">Legal Clauses</button>
          <button class="tab" onclick="showTab('summary')">Summary</button>
        </div>

        <div class="tab-content active" id="clauses-tab">
          <h3>‚öñÔ∏è Clause Analysis</h3>

          <!-- clause explanations area (restored to original full-width behaviour) -->
          <div id="clauseExplanations">
            <p style="text-align:center;color:#7f8c8d;padding:40px;">
              Click "Analyze Clauses" to identify and explain legal terms in your document
            </p>
          </div>

          <!-- MISSING CLAUSES / GAPS (now placed under clause explanations, styled similarly to validity-check) -->
          <div id="missingClausesContainer" style="margin-top:10px;"></div>
        </div>

        <div class="tab-content" id="summary-tab">
          <div class="summary-section" id="summarySection" style="display:block; background:transparent; box-shadow:none; padding:0; margin:0;">
            <div class="summary-content" id="summaryContent" style="background:transparent;">
              <p style="text-align:center; color:#7f8c8d; padding:40px;">Click "Generate Summary" to get a plain English explanation of the document</p>
            </div>
          </div>
        </div>
      </div>

    </div>
  </div>

  <script>
    // initialize pdf.js worker
    if (typeof pdfjsLib !== 'undefined') {
      pdfjsLib.GlobalWorkerOptions.workerSrc = "https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js";
    }

    const fileInput = document.getElementById('fileInput');
    const uploadArea = document.getElementById('uploadArea');
    const progressContainer = document.getElementById('progressContainer');
    const progressFill = document.getElementById('progressFill');
    const progressText = document.getElementById('progressText');
    const mainContent = document.getElementById('mainContent');
    const textDisplay = document.getElementById('textDisplay');
    const clauseExplanations = document.getElementById('clauseExplanations');
    const missingClausesContainer = document.getElementById('missingClausesContainer');
    const summaryContent = document.getElementById('summaryContent');

    let extractedText = '';
    let analyzedClauses = [];

    // formatting helpers (unchanged)
    function escapeHTML(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
    }

    function formatDocument(text) {
      let t = String(text).replace(/\r/g,'').replace(/\u00A0/g,' ').replace(/[ \t]+/g,' ').trim();
      t = t.replace(/([.;:])\s+(?=[A-Z(‚Ä¢\-]|\d)/g, '$1\n');
      t = t.replace(/\s+(Section\s+\d+(\.\d+)*[:.)]?)/gi, '\n$1').replace(/\s+(Clause\s+\d+(\.\d+)*[:.)]?)/gi, '\n$1').replace(/\s+(WHEREAS|NOW,\s*THEREFORE|DEFINITIONS|TERMINATION|GOVERNING LAW|PAYMENT|CONFIDENTIALITY)[:.)]?/gi, '\n$1');
      const lines = t.split(/\n+/).map(s => s.trim()).filter(Boolean);
      const isNum = s => /^\d+(\.\d+)*[.)]?\s+/.test(s);
      const isParen = s => /^\([a-zA-Z0-9ivx]+\)\s+/i.test(s);
      const isBullet = s => /^[‚Ä¢\-‚Äì]\s+/.test(s);
      const blocks = [];
      let buf = []; let mode = null;
      const flush = () => {
        if (!buf.length) return;
        if (mode === 'ol') blocks.push('<ol>' + buf.map(li => `<li>${escapeHTML(li)}</li>`).join('') + '</ol>');
        else if (mode === 'ul') blocks.push('<ul>' + buf.map(li => `<li>${escapeHTML(li)}</li>`).join('') + '</ul>');
        else { const para = buf.join(' ').replace(/\s{2,}/g,' ').trim(); if (para) blocks.push(`<p>${escapeHTML(para)}</p>`); }
        buf = []; mode = null;
      };
      for (const line of lines) {
        if (isNum(line) || isParen(line)) {
          const cleaned = line.replace(/^\d+(\.\d+)*[.)]?\s+/, '').replace(/^\([a-zA-Z0-9ivx]+\)\s+/i, '');
          if (mode !== 'ol') { flush(); mode = 'ol'; } buf.push(cleaned);
        } else if (isBullet(line)) {
          const cleaned = line.replace(/^[‚Ä¢\-‚Äì]\s+/, '');
          if (mode !== 'ul') { flush(); mode = 'ul'; } buf.push(cleaned);
        } else {
          if (mode) flush();
          const parts = line.split(/;\s+/);
          for (let i=0;i<parts.length;i++) { buf.push(parts[i]); if (i < parts.length - 1) flush(); }
        }
      }
      flush();
      return blocks.join('\n');
    }

    // rule-based missing clauses (document-specific)
    const STANDARD_CLAUSES = {
      nda: [
        { key: 'Definitions (Confidential Info)', labels: ['confidential information','definition of confidential'] },
        { key: 'Non-Disclosure', labels: ['non-disclos','not disclose','obliged to keep confidential','non disclosure'] },
        { key: 'Term / Duration', labels: ['term','duration','effective date','term of this agreement'] },
        { key: 'Return or Destroy', labels: ['return or destroy','delete confidential','certify destruction'] },
        { key: 'Governing law', labels: ['governing law','jurisdiction','laws of'] }
      ],
      service: [
        { key: 'Scope of Services', labels: ['scope of work','scope of services','services to be provided'] },
        { key: 'Payment', labels: ['payment','fee','compensation','payable','invoice'] },
        { key: 'Term & Termination', labels: ['termination','term','expire','renewal'] },
        { key: 'Liability / Limitation', labels: ['limitation of liability','liability','cap on liability'] },
        { key: 'Warranty / Representations', labels: ['warrant','representation','guarantee','no warranty'] },
        { key: 'Confidentiality', labels: ['confidential','non-disclos'] },
        { key: 'Governing law', labels: ['governing law','jurisdiction'] }
      ],
      employment: [
        { key: 'Position & Duties', labels: ['position','role','duties','responsibilit'] },
        { key: 'Compensation', labels: ['salary','compensation','wage','pay'] },
        { key: 'Termination', labels: ['termination','notice period','for cause','without cause'] },
        { key: 'Non-compete / Restriction', labels: ['non-compete','restrict','competition'] },
        { key: 'Confidentiality', labels: ['confidential','nda','non-disclos'] }
      ]
    };

    function guessDocumentType() {
      const t = (extractedText || '').toLowerCase();
      if (!t) return 'service';
      if (t.includes('confidential') && t.includes('disclos')) return 'nda';
      if (t.includes('employee') || t.includes('salary') || t.includes('employer')) return 'employment';
      return 'service';
    }

    function checkClauses(documentType = null) {
      if (!extractedText) return { docType: documentType || 'unknown', missing: [] };
      const docType = documentType || guessDocumentType();
      const checklist = STANDARD_CLAUSES[docType] || [];
      const text = extractedText.toLowerCase();
      const missing = checklist.filter(item => !item.labels.some(lbl => text.includes(lbl))).map(item => ({ key: item.key, suggestion: item.labels[0] }));
      return { docType, missing };
    }

    // render missing clauses below clause analysis (restored style)
    function renderMissingClauses(documentType = null) {
      const { docType, missing } = checkClauses(documentType);
      if (!missingClausesContainer) return;
      if (!missing.length) {
        missingClausesContainer.innerHTML = `<div class="validity-check"><strong>No important clauses detected as missing</strong><p style="color:#666;margin-top:8px;">Rule-based check for document type: <strong>${escapeHTML(docType)}</strong></p></div>`;
        return;
      }
      let html = `<div class="validity-check"><h4 style="color:#e74c3c;margin-bottom:8px;">Missing / Likely Missing Clauses</h4><ul style="margin-left:18px;">`;
      missing.forEach(m => {
        html += `<li style="margin:6px 0;"><strong>${escapeHTML(m.key)}</strong> ‚Äî suggestion: add clause about "<em>${escapeHTML(m.suggestion)}</em>"</li>`;
      });
      html += `</ul><p style="font-size:12px;color:#555;margin-top:8px;">(Detected type: ${escapeHTML(docType)} ‚Äî edit STANDARD_CLAUSES to tune)</p></div>`;
      missingClausesContainer.innerHTML = html;
    }

    // file upload handlers
    uploadArea.addEventListener('click', () => fileInput.click());
    uploadArea.addEventListener('dragover', e => { e.preventDefault(); uploadArea.style.borderColor = '#3498db'; });
    uploadArea.addEventListener('dragleave', () => uploadArea.style.borderColor = '#bdc3c7');
    uploadArea.addEventListener('drop', e => { e.preventDefault(); uploadArea.style.borderColor = '#bdc3c7'; const f = e.dataTransfer.files[0]; if (f) handleFile(f); });
    fileInput.addEventListener('change', e => { if (e.target.files[0]) handleFile(e.target.files[0]); });

    function handleFile(file) {
      if (file.type !== 'application/pdf') { alert('Please upload a PDF file.'); return; }
      extractPDF(file);
    }

    async function extractPDF(file) {
      progressContainer.style.display = 'block';
      mainContent.style.display = 'none';
      try {
        const arrayBuffer = await file.arrayBuffer();
        const pdf = await pdfjsLib.getDocument(arrayBuffer).promise;
        const numPages = pdf.numPages;
        extractedText = '';
        for (let i=1;i<=numPages;i++) {
          const page = await pdf.getPage(i);
          const textContent = await page.getTextContent();
          const pageText = textContent.items.map(item => item.str).join(' ');
          extractedText += pageText + '\n\n';
          const progress = Math.round((i/numPages)*100);
          progressFill.style.width = progress + '%';
          progressText.textContent = `Processing page ${i} of ${numPages}...`;
        }

        textDisplay.innerHTML = formatDocument(extractedText);

        // auto-run missing clause rendering (document-specific)
        renderMissingClauses();

        progressContainer.style.display = 'none';
        mainContent.style.display = 'grid';
      } catch (err) {
        console.error('PDF extraction error:', err);
        progressContainer.style.display = 'none';
        showError('Failed to extract text from PDF. Please try a different file.');
      }
    }

    // AI config (kept as before)
    const apiConfigs = {
      google: {
        endpoint: 'https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent',
        buildRequest: (text, type) => ({
          contents: [{
            parts: [{
              text: type === 'analyze' ?
`As a legal expert, analyze this document and identify important legal clauses. For each clause found, provide:
1. The exact text of the clause
2. Clause type (e.g., "Termination", "Payment", "Liability", "Confidentiality")
3. Plain English explanation
4. Potential risks or benefits

Format your response as JSON with this structure:
{
  "clauses": [
    {
      "text": "exact clause text",
      "type": "Clause Type",
      "explanation": "plain English explanation",
      "risk_level": "low/medium/high"
    }
  ]
}

Document text:
${text}` :
`Summarize this legal document in plain English, focusing on key obligations, rights, and important terms:

${text}`
            }]
          }]
        }),
        extractResponse: (data) => { try { return data.candidates[0].content.parts[0].text } catch { return '' } },
        buildHeaders: (apiKey) => ({ 'Content-Type': 'application/json' }),
        getEndpoint: (apiKey) => `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`
      }
    };

    async function analyzeDocument() {
      const apiKey = document.getElementById('apiKey').value.trim();
      if (!apiKey) { alert('Please enter your API key'); return; }
      if (!extractedText) { alert('Please upload a document first'); return; }

      clauseExplanations.innerHTML = '<div class="loading">Analyzing legal clauses...</div>';
      showTab('clauses');

      try {
        const config = apiConfigs.google;
        const endpoint = config.getEndpoint(apiKey);
        const requestData = config.buildRequest(extractedText, 'analyze');
        const headers = config.buildHeaders(apiKey);

        const response = await fetch(endpoint, { method:'POST', headers, body: JSON.stringify(requestData) });
        if (!response.ok) throw new Error(`API error: ${response.status}`);

        const data = await response.json();
        const analysisText = config.extractResponse(data);

        let analysisData;
        try {
          const jsonMatch = analysisText.match(/\{[\s\S]*\}/);
          if (jsonMatch) analysisData = JSON.parse(jsonMatch[0]);
          else throw new Error('No JSON found in response');
        } catch (parseError) {
          analysisData = { clauses: [{ text: "Analysis completed", type: "General", explanation: analysisText, risk_level: "medium" }] };
        }

        displayClauseAnalysis(analysisData.clauses || []);
        highlightClausesInText(analysisData.clauses || []);

        // update missing clauses under the clause analysis (document-specific)
        renderMissingClauses();

      } catch (error) {
        console.error('Analysis error:', error);
        clauseExplanations.innerHTML = `<div class="error">Failed to analyze document: ${error.message}</div>`;
      }
    }

    function displayClauseAnalysis(clauses) {
      if (!clauses.length) { clauseExplanations.innerHTML = '<p>No specific clauses identified.</p>'; return; }
      let html = '';
      clauses.forEach((clause) => {
        const riskColor = { 'low':'#27ae60','medium':'#f39c12','high':'#e74c3c' }[clause.risk_level] || '#3498db';
        html += `
          <div class="clause-explanation">
            <span class="clause-type" style="background:${riskColor};">${escapeHTML(clause.type||'Clause')}</span>
            <h4 style="margin:10px 0; color:#2c3e50;">${escapeHTML((clause.type||'Clause') + ' Clause')}</h4>
            <p style="margin-bottom:15px;"><strong>Found text:</strong> "${escapeHTML((clause.text||'').substring(0,100))}${(clause.text||'').length>100 ? '...' : ''}"</p>
            <p><strong>Explanation:</strong> ${escapeHTML(clause.explanation||'')}</p>
            <p style="margin-top:10px;font-size:12px;color:#7f8c8d;">Risk Level: ${escapeHTML(String(clause.risk_level||'').toUpperCase())}</p>
          </div>
        `;
      });
      clauseExplanations.innerHTML = html;
    }

    function highlightClausesInText(clauses) {
      let highlightedText = extractedText;
      clauses.forEach((clause) => {
        if (clause.text && clause.text.length > 10) {
          const searchText = clause.text.substring(0,50);
          const regex = new RegExp(searchText.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'), 'gi');
          highlightedText = highlightedText.replace(regex, `<span class="clause-highlight" title="${escapeHTML(clause.type)}: ${escapeHTML((clause.explanation||'').substring(0,100))}...">$&</span>`);
        }
      });
      textDisplay.innerHTML = `<div style="white-space:pre-wrap;font-family:inherit;line-height:1.6;">${highlightedText}</div>`;
    }

    async function generateSummary() {
      const apiKey = document.getElementById('apiKey').value.trim();
      if (!apiKey) { alert('Please enter your API key'); return; }
      if (!extractedText) { alert('Please upload a document first'); return; }

      summaryContent.innerHTML = '<div class="loading">Generating summary...</div>';
      showTab('summary');

      try {
        const config = apiConfigs.google;
        const endpoint = config.getEndpoint(apiKey);
        const requestData = config.buildRequest(extractedText, 'summary');
        const headers = config.buildHeaders(apiKey);

        const response = await fetch(endpoint, { method:'POST', headers, body: JSON.stringify(requestData) });
        if (!response.ok) throw new Error(`API error: ${response.status}`);
        const data = await response.json();
        const summary = config.extractResponse(data);
        summaryContent.innerHTML = summary.replace(/\n/g,'<br>');
      } catch (error) {
        console.error('Summary error:', error);
        summaryContent.innerHTML = `<div class="error">Failed to generate summary: ${error.message}</div>`;
      }
    }

    function showTab(tabName) {
      document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
      document.querySelector(`.tab:nth-child(${tabName==='clauses' ? 1 : 2})`).classList.add('active');
      document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
      document.getElementById(`${tabName}-tab`).classList.add('active');
    }

    function showError(message) {
      const errorDiv = document.createElement('div');
      errorDiv.className = 'error';
      errorDiv.textContent = message;
      document.querySelector('.container').insertBefore(errorDiv, mainContent);
      setTimeout(()=>errorDiv.remove(), 5000);
    }
  </script>
</body>
</html>

